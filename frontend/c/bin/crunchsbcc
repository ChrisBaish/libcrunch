#!/usr/bin/env python
# ... or for debugging, use something like
#!/home/stephen/bin/gdbrun python

# Compiler wrapper for libcrunch.
import os, sys, re, subprocess, tempfile

# HACK
if "LIBALLOCS" in os.environ:
    liballocs_base = os.path.realpath(os.environ["LIBALLOCS"])
else:
    liballocs_base = os.path.realpath(os.path.dirname(sys.argv[0]) + "/../../../../liballocs/")
sys.path.append(liballocs_base + "/tools")
sys.path.append(liballocs_base + "/tools/lang/c/lib")
from allocscc import AllocsCC
sys.path.append(os.path.realpath(os.path.dirname(__file__) + "/../lib"))
from crunchcc import CrunchCC

class CrunchSBCC(CrunchCC):
    
    def doPostLinkMetadataBuild(self, outputFile):
        # SoftBound doesn't need metadata (er, hopefully)
        return 0
    
    def getDefines(self):
        #    "-DLIBCRUNCH_TRACE_BOUNDS_STACK", \
        return ["-DLIBCRUNCH_EMULATE_SOFTBOUND", \
            "-DLIBCRUNCH_VOID_POINTERS_HAVE_BOUNDS", \
            "-DLIBCRUNCH_ABORT_ON_OOB_DEREF", \
            "-DLIBCRUNCH_NO_POINTER_TYPE_INFO", \
            "-DLIBCRUNCH_NO_SECONDARY_DERIVE_PATH", \
            "-DLIBCRUNCH_LONG_SIZE", \
            "-DLIBCRUNCH_NO_DENORM_BOUNDS"]
    
    def getStubGenCompileArgs(self):
        # We have to include the CIL inlines with the appropriate flags
        # and then define the init, fini and argwise hooks
        # so that they do the shadow bounds stack stuff
        return ["-include", self.getLibAllocsBaseDir() + "/include/uniqtype.h"] \
            + self.getDefines() + [ \
            "-include", \
                os.path.dirname(__file__) + "/../../../include/libcrunch_cil_inlines.h", \
            "-include", \
                os.path.dirname(__file__) + "/../../../include/stubgen_softbound.h" \
        ]
    
    # this one is for a final link
    def getExtraLinkArgs(self):
        return [os.path.dirname(__file__) + "/../../../lib/libcrunch_wrappers.o", \
                "-Wl,@" + os.path.dirname(__file__) + "/../../../lib/wrap.ldopts"]
    
    # this one is for the *.linked.o big-object link step
    def getExtraRelocLinkArgs(self):
        return []

    def getCillyArgs(self, sourceFiles):
        # PROBLEM: we only want to -include if we're compiling a C file. 
        # Note that normally cilly will figure out when we're compiling
        # a .S file, say, and only pass options that are relevant. But
        # it would be asking too much in this case. 
        
        allSourceFilesAreC = True
        for sourceFile in sourceFiles:
            if sourceFile.lang != "c" and not sourceFile.endswith(".c"):
                allSourceFilesAreC = False
        
        includeArgs = []
#            "--load=%s" % (os.path.dirname(sys.argv[0]) + "/../vsimplemem/vsimplemem.cmxs"), "--dovsimpleMem", \
#            "--load=%s" % (os.path.dirname(sys.argv[0]) + "/../vsimpleaddr/vsimpleaddr.cmxs"), "--dovsimpleAddr", \

        if len(sourceFiles) > 0 and allSourceFilesAreC:
            #"-DLIBCRUNCH_TRACE_BOUNDS_STACK", \
            # We can only do trumptr, and anything else that involves -include, 
            # if we're compiling only C files.
            # temporary HACK to strip line numbers after preprocess
            #"--commPrintLn",
            includeArgs = [ \
            "-include", self.getLibAllocsBaseDir() + "/include/uniqtype-defs.h"] \
                + self.getDefines() + [ \
            "-include", \
                os.path.dirname(__file__) + "/../../../include/libcrunch_cil_inlines.h", \
            "--load=%s" % (os.path.dirname(sys.argv[0]) + "/../ptrintarith/ptrintarith.cmxs"), "--doptrintarith", \
            "--load=%s" % (os.path.dirname(sys.argv[0]) + "/../crunchbound/crunchbound.cmxs"), "--docrunchbound", \
            "--emulate-softbound"  \
                ]
        else:
            self.debugMsg("No source files, or not all (only %d) are C files\n" % len(sourceFiles))
        
        return AllocsCC.getCillyArgs(self, sourceFiles) + \
            ["--keepunused"] \
            + includeArgs + \
            ["-Wno-unused-variable", "-Wno-unused-label"]
            # We need the above -Wno-unused-... because CIL creates
            # some unused stuff (unavoidably, I believe) which will
            # make compilation done with -Werror barf if we don't
            # silence them.

if __name__ == '__main__':
    wrapper = CrunchSBCC()
    ret = wrapper.main()
    exit(ret)

